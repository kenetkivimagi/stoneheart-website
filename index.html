<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stoneheart</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.26.1.min.js"></script>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  background-color: #f0f2f5;
  color: #333;
  font-size: 15px;
}
.header-container {
  background: linear-gradient(135deg, #0a1a33, #16264d);
  padding: 10px 15px 5px 15px;
  color: white;
  border-bottom-left-radius: 15px;
  border-bottom-right-radius: 15px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.25);
}
.header-container h1 {
  margin: 0 0 5px 0;
  font-size: 1.6em;
  font-weight: 700;
}
.tab-container {
  display: flex;
  flex-wrap: wrap;
}
.tab {
  cursor: pointer;
  padding: 6px 14px;
  margin-right: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px 10px 0 0;
  font-weight: 500;
  transition: 0.3s;
  color: white;
  font-size: 0.85em;
}
.tab:hover { background: rgba(255,255,255,0.2); }
.tab.active { background: rgba(255,255,255,0.3); font-weight: bold; }
.tab-content {
  border: none;
  border-radius: 10px;
  padding: 20px; 
  margin: 15px auto;
  display: none;
  background: #fff;
  max-width: 1200px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
.tab-content.active { display: block; }
.responsive-iframe {
  position: relative;
  width: 100%;
  padding-bottom: 120%;
  height: 0;
  overflow: hidden;
  margin: 10px 0;
}
.responsive-iframe iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 10px;
  border: 1px solid #ccc;
  background-color: white;
}
#refresh {
  background: #16264d;
  color: white;
  border: none;
  padding: 8px 18px;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
  margin-bottom: 12px;
  transition: 0.3s;
}
#refresh:hover { background: #0a1a33; }
.dataTables_wrapper { font-size: 13px; }
#growthTable { border-radius: 8px; overflow: hidden; }
#growthTable tbody tr:hover { background-color: #f1f7ff; }
#growthTable tbody td { text-align: center; padding: 8px; }
#growthTable tbody td.negative { color: #d9534f; font-weight: bold; }
#growthTable tbody td.positive { color: #5cb85c; font-weight: bold; }
#portfolioLine, #portfolioEWMA {
  width: 100%;
  height: 450px;
  border-radius: 10px;
  background: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  padding: 10px;
}
@media (max-width: 600px) {
  .header-container h1 { font-size: 1.2em; }
  .tab { padding: 4px 8px; font-size: 0.75em; margin-right: 2px; }
  #portfolioLine, #portfolioEWMA { height: 300px; }
}
</style>
</head>
<body>

<div class="header-container">
  <h1>Stoneheart</h1>
  <div class="tab-container">
    <div class="tab active" data-tab="cv">ðŸ“„ CV</div>
    <div class="tab" data-tab="stocks">ðŸ“ˆ Top Stock Picks</div>
    <div class="tab" data-tab="growth">ðŸ’¹ Growth Tracker</div>
  </div>
</div>

<div id="cv" class="tab-content active" style="background-color: #e0e0e0; padding: 10px 0;">
  <div class="responsive-iframe">
    <iframe src="https://drive.google.com/file/d/1gaxYPlfA4Hqq7lEqLN5UXtuVqMgGdK3U/preview"></iframe>
  </div>
</div>

<div id="stocks" class="tab-content">
  <div class="responsive-iframe">
    <iframe src="web.html"></iframe>
  </div>
</div>

<div id="growth" class="tab-content">
  <button id="refresh">ðŸ”„ Refresh Data</button>
  <p id="lastRefresh" style="font-weight: bold; margin-bottom: 12px;"></p>
  <h3>Tickers Table</h3>
  <table id="growthTable" class="display" style="width:100%"></table>
  <h3 style="margin-top:30px;">Rolling Portfolio Growth</h3>
  <div id="portfolioLine"></div>
  <h3 style="margin-top:30px;">Rolling EWMA</h3>
  <div id="portfolioEWMA"></div>
</div>

<script>
$('.tab').click(function(){
  $('.tab').removeClass('active');
  $(this).addClass('active');
  $('.tab-content').removeClass('active');
  const tabId = $(this).data('tab');
  $('#' + tabId).addClass('active');
  if(tabId === 'growth'){
    Plotly.Plots.resize('portfolioLine');
    Plotly.Plots.resize('portfolioEWMA');
  }
});

const sheetId = "1hhUODYN7x6jwQ_GwAvVHCjqfge7wRzTDrKQbqqVR6uI";
const tickersCSV = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Tickers`;
const historyCSV = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Growth_History`;

function parseCSV(text) {
  const rows = text.trim().split('\n');
  const headers = rows[0].split(',').map(h => h.replace(/"/g,'').trim());
  return rows.slice(1).map(row => {
    const values = row.split(',').map(v => v.replace(/"/g,'').trim());
    let obj = {};
    headers.forEach((h,i) => obj[h] = values[i] ?? "");
    return obj;
  });
}

function formatDateShort(date) {
  const day = date.getDate();
  const month = date.toLocaleString('en-GB', { month: 'short' });
  return `${day}. ${month}`;
}

async function loadGrowthData() {
  try {
    const tickersText = await (await fetch(tickersCSV)).text();
    const tickersData = parseCSV(tickersText);

    const tableData = tickersData.map(t => ({
      Ticker: t.Ticker,
      Price_Today: t.Price_Today,
      Current_Price: t.Current_Price,
      Growth_Percent: t.Growth ? parseFloat(t.Growth).toFixed(2) + '%' : "",
      GrowthClass: parseFloat(t.Growth) >= 0 ? 'positive' : 'negative'
    }));

    if ($.fn.dataTable.isDataTable('#growthTable')) {
      const dt = $('#growthTable').DataTable();
      dt.clear().rows.add(tableData).draw();
    } else {
      $('#growthTable').DataTable({
        data: tableData,
        columns: [
          { title: "Ticker", data: "Ticker" },
          { title: "Price 23.09.2025", data: "Price_Today" },
          { title: "Current Price", data: "Current_Price" },
          { title: "Growth %", data: "Growth_Percent",
            createdCell: function(td, cellData, rowData) {
              $(td).addClass(rowData.GrowthClass);
            }
          }
        ],
        paging: false,
        searching: false,
        ordering: false,
        responsive: true
      });
    }

    const historyText = await (await fetch(historyCSV)).text();
    const historyData = parseCSV(historyText);

    const times = historyData.map(h => new Date(h.Timestamp));
    const avgGrowth = historyData.map(h => parseFloat(h.Avg_Growth) || 0);

    const trace = {
      x: times,
      y: avgGrowth,
      mode: 'lines+markers',
      line: { color: '#2c7fb8', width: 3 },
      marker: { color: '#f03b20', size: 7 },
      hovertemplate: '%{y:.2f}%<br>%{x|%d. %b}<extra></extra>'
    };

    const layout = {
      title: "Average Portfolio Growth",
      xaxis: {
        title: "Date",
        tickvals: times,
        ticktext: times.map(d => formatDateShort(d)),
        tickangle: -45
      },
      yaxis: { title: "Average Growth (%)" },
      margin: { t: 55, b: 70 },
      plot_bgcolor: "#fff",
      paper_bgcolor: "#fff"
    };

    Plotly.newPlot('portfolioLine', [trace], layout, {responsive: true});
    document.getElementById('lastRefresh').innerText =
      `Last refreshed: ${formatDateShort(new Date())}`;
  } catch (err) {
    console.error(err);
    alert("Failed to load data. Check console.");
  }
}

async function loadEWMAGraph() {
  try {
    const ewmaCSV = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=EWMA`;
    const ewmaText = await (await fetch(ewmaCSV)).text();
    const ewmaData = parseCSV(ewmaText);

    const timesEWMA = ewmaData.map(h => new Date(h.Timestamp));
    const avgEWMA = ewmaData.map(h => parseFloat(h.EWMA_Volatility).toFixed(4) || 0);
    const ucl = ewmaData.map(h => parseFloat(h.UCL).toFixed(4) || 0);
    const lcl = ewmaData.map(h => parseFloat(h.LCL).toFixed(4) || 0);

    // Median calculation
    const sorted = [...avgEWMA].sort((a,b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    const median = sorted.length % 2 !== 0 ? sorted[mid] : ((parseFloat(sorted[mid-1]) + parseFloat(sorted[mid])) / 2).toFixed(4);

    const traceEWMA = {
      x: timesEWMA,
      y: avgEWMA,
      mode: 'lines+markers',
      line: { color: '#2c7fb8', width: 3, shape: 'linear' },
      marker: { color: '#f03b20', size: 7 },
      hovertemplate: '%{y:.4f}%<br>%{x|%d. %b}<extra></extra>',
      name: 'EWMA'
    };

    const traceUCL = {
      x: timesEWMA,
      y: ucl,
      mode: 'lines',
      line: { color: 'red', width: 2, shape: 'linear' },
      name: 'UCL'
    };

    const traceLCL = {
      x: timesEWMA,
      y: lcl,
      mode: 'lines',
      line: { color: 'red', width: 2, shape: 'linear' },
      name: 'LCL'
    };

    const layoutEWMA = {
      title: { text: "Rolling EWMA", font: { family: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif', size: 16 } },
      xaxis: {
        title: { text: "Date", font: { family: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif', size: 14 } },
        tickvals: timesEWMA,
        ticktext: timesEWMA.map(d => formatDateShort(d)),
        tickangle: -45,
        tickfont: { family: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif', size: 12 }
      },
      yaxis: { 
        title: { text: "EWMA (%)", font: { family: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif', size: 14 } },
        tickfont: { family: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif', size: 12 }
      },
      margin: { t: 55, b: 70 },
      plot_bgcolor: "#fff",
      paper_bgcolor: "#fff",
      shapes: [
        {
          type: 'line',
          x0: timesEWMA[0],
          x1: timesEWMA[timesEWMA.length-1],
          y0: median,
          y1: median,
          line: { color: 'black', width: 2, dash: 'dash' }
        }
      ]
    };

    Plotly.newPlot('portfolioEWMA', [traceEWMA, traceUCL, traceLCL], layoutEWMA, {responsive: true});
  } catch (err) {
    console.error(err);
    alert("Failed to load EWMA data. Check console.");
  }
}

async function loadAllGrowthData() {
  await loadGrowthData();
  await loadEWMAGraph();
}

loadAllGrowthData();
document.getElementById('refresh').addEventListener('click', loadAllGrowthData);
</script>

</body>
</html>
